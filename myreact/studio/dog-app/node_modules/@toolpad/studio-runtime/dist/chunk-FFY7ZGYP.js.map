{"version":3,"sources":["../src/runtime.tsx"],"sourcesContent":["import * as React from 'react';\nimport { ErrorBoundary, FallbackProps } from 'react-error-boundary';\nimport { Emitter } from '@toolpad/utils/events';\nimport * as ReactIs from 'react-is';\nimport { hasOwnProperty } from '@toolpad/utils/collections';\nimport { createProvidedContext } from '@toolpad/utils/react';\nimport { Stack } from '@mui/material';\nimport { RuntimeEvents, ToolpadComponents, ToolpadComponent, ArgTypeDefinition } from './types';\nimport { TOOLPAD_COMPONENT } from './constants';\nimport type {\n  RuntimeEvent,\n  RuntimeError,\n  PaginationMode,\n  ToolpadDataProviderBase,\n  NodeId,\n} from './types';\nimport { createComponent } from './browser';\n\nconst ResetNodeErrorsKeyContext = React.createContext(0);\n\nexport const ResetNodeErrorsKeyProvider = ResetNodeErrorsKeyContext.Provider;\n\nexport type Components = ToolpadComponents;\n\nexport const ComponentsContext = React.createContext<ToolpadComponents | null>(null);\n\ndeclare global {\n  interface Window {\n    __TOOLPAD_RUNTIME_EVENT__?: RuntimeEvent[] | ((event: RuntimeEvent) => void);\n  }\n}\n\nexport const NodeRuntimeContext = React.createContext<{\n  nodeId: NodeId | null;\n  nodeName: string | null;\n}>({\n  nodeId: null,\n  nodeName: null,\n});\nexport const CanvasEventsContext = React.createContext<Emitter<RuntimeEvents> | null>(null);\n\nexport interface NodeErrorProps {\n  error: RuntimeError;\n}\n\nexport interface NodeRuntimeWrapperProps {\n  children: React.ReactElement;\n  nodeId: NodeId;\n  nodeName: string;\n  NodeError: React.ComponentType<NodeErrorProps>;\n}\n\nexport function NodeRuntimeWrapper({\n  nodeId,\n  nodeName,\n  children,\n  NodeError,\n}: NodeRuntimeWrapperProps) {\n  const resetNodeErrorsKey = React.useContext(ResetNodeErrorsKeyContext);\n\n  const ErrorFallback = React.useCallback(\n    ({ error }: FallbackProps) => <NodeError error={error} />,\n    [NodeError],\n  );\n\n  const nodeRuntimeValue = React.useMemo(() => ({ nodeId, nodeName }), [nodeId, nodeName]);\n\n  return (\n    <ErrorBoundary resetKeys={[resetNodeErrorsKey]} fallbackRender={ErrorFallback}>\n      <NodeRuntimeContext.Provider value={nodeRuntimeValue}>{children}</NodeRuntimeContext.Provider>\n    </ErrorBoundary>\n  );\n}\n\nexport interface NodeRuntime<P> {\n  nodeId: string | null;\n  nodeName: string | null;\n  updateAppDomConstProp: <K extends keyof P & string>(\n    key: K,\n    value: React.SetStateAction<P[K]>,\n  ) => void;\n  updateEditorNodeData: (key: string, value: any) => void;\n}\n\nexport function useNode<P = {}>(): NodeRuntime<P> | null {\n  const { nodeId, nodeName } = React.useContext(NodeRuntimeContext);\n  const canvasEvents = React.useContext(CanvasEventsContext);\n\n  return React.useMemo(() => {\n    if (!nodeId || !canvasEvents) {\n      return null;\n    }\n    const nodeRuntime: NodeRuntime<P> = {\n      nodeId,\n      nodeName,\n      updateAppDomConstProp: (prop, value) => {\n        canvasEvents.emit('propUpdated', {\n          nodeId,\n          prop,\n          value,\n        });\n      },\n      updateEditorNodeData: (prop: string, value: any) => {\n        canvasEvents.emit('editorNodeDataUpdated', {\n          nodeId,\n          prop,\n          value,\n        });\n      },\n    };\n\n    return nodeRuntime;\n  }, [canvasEvents, nodeId, nodeName]);\n}\n\nexport interface PlaceholderProps {\n  prop: string;\n  children?: React.ReactNode;\n}\n\nexport function Placeholder({ prop, children }: PlaceholderProps) {\n  const { nodeId } = React.useContext(NodeRuntimeContext);\n  if (!nodeId) {\n    return <React.Fragment>{children}</React.Fragment>;\n  }\n  const count = React.Children.count(children);\n  return count > 0 ? (\n    <React.Fragment>{children}</React.Fragment>\n  ) : (\n    <div\n      style={{\n        minHeight: 72,\n        minWidth: 200,\n      }}\n      data-toolpad-slot-name={prop}\n      data-toolpad-slot-parent={nodeId}\n      data-toolpad-slot-type=\"single\"\n    />\n  );\n}\n\nexport interface SlotsProps {\n  prop: string;\n  children?: React.ReactNode;\n  hasLayout?: boolean;\n}\n\nexport function Slots({ prop, children, hasLayout = false }: SlotsProps) {\n  const { nodeId } = React.useContext(NodeRuntimeContext);\n  if (!nodeId) {\n    return <React.Fragment>{children}</React.Fragment>;\n  }\n  const count = React.Children.count(children);\n\n  if (count <= 0) {\n    return <Placeholder prop={prop} />;\n  }\n\n  if (hasLayout) {\n    return (\n      <Stack\n        direction=\"column\"\n        sx={{\n          gap: 1,\n        }}\n        data-toolpad-slot-name={prop}\n        data-toolpad-slot-parent={nodeId}\n        data-toolpad-slot-type=\"layout\"\n      >\n        {children}\n      </Stack>\n    );\n  }\n\n  return <React.Fragment>{children}</React.Fragment>;\n}\n\nexport function isToolpadComponent(\n  maybeComponent: unknown,\n): maybeComponent is ToolpadComponent<any> {\n  if (\n    !ReactIs.isValidElementType(maybeComponent) ||\n    typeof maybeComponent === 'string' ||\n    !hasOwnProperty(maybeComponent, TOOLPAD_COMPONENT)\n  ) {\n    return false;\n  }\n\n  return true;\n}\n\nexport function getArgTypeDefaultValue<P extends object, K extends keyof P>(\n  argType: ArgTypeDefinition<P, K>,\n): P[K] | undefined {\n  return argType.default ?? argType.defaultValue ?? undefined;\n}\n\nexport function createToolpadComponentThatThrows(error: Error) {\n  return createComponent(() => {\n    throw error;\n  });\n}\n\nconst [useComponents, ComponentsContextProvider] =\n  createProvidedContext<ToolpadComponents>('Components');\n\nexport { useComponents, ComponentsContextProvider };\n\nexport function useComponent(id: string) {\n  const components = useComponents();\n  return React.useMemo(() => {\n    return (\n      components?.[id] ??\n      createToolpadComponentThatThrows(new Error(`Can't find component for \"${id}\"`))\n    );\n  }, [components, id]);\n}\n\nexport interface ToolpadDataProviderIntrospection {\n  paginationMode: PaginationMode;\n  hasDeleteRecord: boolean;\n  hasUpdateRecord: boolean;\n  hasCreateRecord: boolean;\n}\n\nexport interface UseDataProviderHookResult<\n  R extends Record<string, unknown>,\n  P extends PaginationMode,\n> {\n  isLoading: boolean;\n  error?: unknown;\n  dataProvider: ToolpadDataProviderBase<R, P> | null;\n}\n\nexport interface UseDataProviderHook {\n  <R extends Record<string, unknown>, P extends PaginationMode>(\n    id: string | null,\n  ): UseDataProviderHookResult<R, P>;\n}\n\nconst DEFAULT_DATA_PROVIDER_HOOK: UseDataProviderHook = (id) => ({\n  dataProvider: null,\n  isLoading: false,\n  error: id ? new Error(\"This environment doesn't support data providers\") : undefined,\n});\n\nexport const UseDataProviderContext = React.createContext<UseDataProviderHook>(\n  DEFAULT_DATA_PROVIDER_HOOK,\n);\n"],"mappings":"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","names":[]}